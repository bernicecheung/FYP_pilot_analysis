---
title: "FYP_pilot_dataCleaning"
author: "Bernice Cheung"
date: "1/14/2020"
output: html_document
---
# Set up the environment
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, results = 'hide', warning=FALSE}
library(plyr)
library(tidyverse)
library(psych)
library(ggplot2)
library(stringr)
```

Raw data is downloaded from Qualtric. Non-consented participants are filtered out before downloading. Pilot study has collect 54 subjects by 1.24th 
```{r raw data}
# load raw data
rawDf <- read.csv("../raw_data/Goal Representation-SONA_January 24, 2020_04.55.csv",stringsAsFactors = F)
```

# Organize the raw dataframe
```{r organize raw df}
# delete the first two rows of labels and questions 
rawDf_cleaned <- rawDf[-c(1,2),]

# write the data without the 2 rows
write.csv(rawDf_cleaned,"../raw_data/raw_clean.csv",row.names = F)

# reload the raw cleaned dataframe
rawDf_cleaned <- read.csv("../raw_data/raw_clean.csv",stringsAsFactors = F)
```

# Data Screening

### Task Duration

4 subjects spent around 3 or above 3 hours, which means they didn't complete the survey all at once.  
3 subjects spent less than 6 minutes per goal, and we should exclude them. 
```{r long duration}
# convert the duration in seconds to minutes
rawDf_cleaned$Duration <- rawDf_cleaned$Duration..in.seconds./60

# Generate the number of goals subject listed
list_df <- rawDf_cleaned %>% dplyr::select(contains("goal_list"))
rawDf_cleaned$listNum <- rowSums(list_df != "")

# Generate the duration per goal
rawDf_cleaned$timePerGoal <- rawDf_cleaned$Duration/rawDf_cleaned$listNum

# Descriptive on duration
describe(rawDf_cleaned$timePerGoal)

# Histograme
hist(rawDf_cleaned$timePerGoal)

# subjects who used more than 3 hours to complte the task
id_durationLong <- rawDf_cleaned[rawDf_cleaned$Duration > 180,c("id", "Duration", "listNum")]
id_durationLong

# re-do descriptive after removing those participants
rawDf_cleaned %>% filter(!id %in% id_durationLong$id) %>% dplyr::select(timePerGoal) %>% describe()
rawDf_cleaned %>% filter(!id %in% id_durationLong$id) %>% ggplot(aes(timePerGoal)) + geom_histogram(fill   = "orange",
                   colour = "black",
                   alpha  = .6)

# subjects who used less then 6 minutes per goal
id_durationShort <- rawDf_cleaned[rawDf_cleaned$timePerGoal <6,c("id", "Duration", "listNum")]
id_durationShort
```

### Attention check question
14 subjects missed at least 1 attention check question. We exclude subjects who missed 1 attention check question in the individual differences scales. There are 5 subjects we excluded
```{r exclude attention check}
# extract attention check questions
checkDf <- rawDf_cleaned[,grepl("check",names(rawDf_cleaned))]
checkDf$id <- rawDf_cleaned$id

# compare to correct answers
checkDf <- checkDf %>% mutate(corr_1 = check1 =="17")
checkDf <- checkDf %>% mutate(corr_2 = check2 ==3)
checkDf <- checkDf %>% mutate(corr_3 = check3 ==5)
checkDf$corr_sum <- rowSums(checkDf[,c("corr_1","corr_2","corr_3")],na.rm = T)

# extract subject id with at least 2 wrong answer
id_missCheck <- checkDf %>% filter(corr_2 == FALSE | corr_3 == FALSE)
id_missCheck
# combine dataset
rawDf_cleaned <- left_join(rawDf_cleaned, checkDf, by = "id")
```

### Invariant response
We exclude subjects who have more than 20 repetitive responses 
```{r}
# extract columns with likert scale ratings 
ratingDf <- dplyr::select(rawDf_cleaned, "G1_1":"LET6")

# extract the max number of invariant response in a row
variation <- apply(ratingDf,1,function(x) rle(x))
variation.length <-unlist(lapply(variation,function(x) max(x$lengths)))
describe(variation.length)
hist(variation.length)
rawDf_cleaned$invariance_max <- variation.length
# extract subject id who has more than 20 repetitive response in a row
id_invariance <- rawDf_cleaned$id[variation.length > 20]
```

### Exclude participant
Exclude participants based on task duration, attention check questions and invariance response. In total, we exclude 7 subjects. 47 subjects are included in the cleaned dataset.
```{r}
# aggregate id and relevent info.
id_candidate <- unique(c(id_durationShort$id, id_missCheck$id, id_invariance))
candidateDf <- rawDf_cleaned %>% dplyr::select(c("id", "Duration", "listNum", "corr_sum", "invariance_max")) %>% filter(id %in% id_candidate)
candidateDf

# exclude subject from the dataset 
cleanedDf <- rawDf_cleaned[! rawDf_cleaned$id %in% candidateDf$id, ]
```

### transform dataset to long format
```{r}
# subset goal rating related dataset 
goalRating <- subset(cleanedDf, select = G1_1:G35_5)
goalRating <- bind_cols(goalRating, cleanedDf[,c("id","listNum", "total_goal")])

# transform the dataset to long format
goalRating_long <- goalRating %>% gather(dimension, rating, G1_1:G35_5)

# transform existing question number to the corresponding dimension name and goal number

goalRating_long$goal <- str_sub(goalRating_long$dimension,-1,-1)

dimensionName <- c("construal_level", "temporal_duration", "frequency", "specificity", "end_state_specificity", "approach_avoidance", "attainment_maintenance", "measurability", "importance", "meaningfulness", "instrumentality", "connectedness", "attractiveness_achievement", "attractiveness_progress", "social_desirability", "difficulty", "affordance", "attainability", "clarity", "control", "external_motivation", "introjected_motivation", "identified_motivation", "intrinsic_motivation", "ought_motivation", "ideal_motivation", "basic_needs", "commonality", "visibility", "external_importance")
progressName <- c("commitment", "urgency", "effort", "advancement", "initial_time")
nameList <- c(dimensionName, progressName)
questionNum <- paste0("G", 1:35, "_")

nameDf <- data.frame("question_number" = questionNum,
                     "dimension_name" = nameList)

for (idx in 1: nrow(nameDf)){
  goalRating_long$dimension[grepl(nameDf$question_number[idx],goalRating_long$dimension)] <- as.character(nameDf$dimension_name[idx])
}

# get rid off the NAs due to having fewer than 5 goals
goalRating_long <- goalRating_long[goalRating_long$goal <= goalRating_long$listNum,]

```

### Transform data
```{r}
# replace ratings for "I'm not sure" to 99 on dimension "construal_level","approach_avoidance","attainment_maintenance"
goalRating_long_R <- goalRating_long 

dimension_idx <- which(goalRating_long_R$dimension %in% c("construal_level","approach_avoidance","attainment_maintenance") == T & goalRating_long_R $ rating == 4)

goalRating_long_R$rating[dimension_idx] <- 99

# replace ratings for "not specified" to 999 on dimension temporal_duration, frequency, end_state_specificity
dimension_idx <- which(goalRating_long_R$dimension == "temporal_duration" & goalRating_long_R $ rating == 5)
goalRating_long_R$rating[dimension_idx] <- 999

dimension_idx <- which(goalRating_long_R$dimension == "frequency" & goalRating_long_R $ rating == 3)
goalRating_long_R$rating[dimension_idx] <- 999

dimension_idx <- which(goalRating_long_R$dimension == "end_state_specificity" & goalRating_long_R $ rating == 4)
goalRating_long_R$rating[dimension_idx] <- 999


# reverse code approach_avoidance, initial_time, end_state_specificity
goalRating_long_R$rating[goalRating_long_R$dimension == "approach_avoidance"] <- recode(goalRating_long_R$rating[goalRating_long_R$dimension == "approach_avoidance"], '1' = 7, '2' = 6, '3' = 5, '5' = 3, '6' = 2, '7' = 1)
goalRating_long_R$dimension[goalRating_long_R$dimension == "approach_avoidance"] <- "approach_avoidance_R"

goalRating_long_R$rating[goalRating_long_R$dimension == "initial_time"] <- recode(goalRating_long_R$rating[goalRating_long_R$dimension == "initial_time"], '1' = 8, '2' = 7, '3' = 6, '4' = 5 , '5' = 4, '6' = 3, '7' = 2, '8' = 1)
goalRating_long_R$dimension[goalRating_long_R$dimension == "initial_time"] <- "initial_time_R"

goalRating_long_R$rating[goalRating_long_R$dimension == "end_state_specificity"] <- recode(goalRating_long_R$rating[goalRating_long_R$dimension == "end_state_specificity"], '1' = 3, '2' = 2, '3' = 1)
goalRating_long_R$dimension[goalRating_long_R$dimension == "end_state_specificity"] <- "end_state_specificity_R"
```

### Missing data & special cases
```{r}
# check missing data to see if there's systemetic issue for a specific subject or a dimension
missing_dimension <- goalRating_long_R$dimension[is.na(goalRating_long_R$rating)]
missing_id <- goalRating_long_R$id[is.na(goalRating_long_R$rating)]
length(missing_dimension)
table(missing_dimension)
table(missing_id)
```

```{r}
# check "I'm not sure" option
notSure_dimension <- goalRating_long_R$dimension[goalRating_long_R$rating == 99]
notSure_id <- goalRating_long_R$id[goalRating_long_R$rating == 99]
table(notSure_dimension)
table(notSure_id)
```

```{r}
# check not specified option
notSpecified_dimension <- goalRating_long_R$dimension[goalRating_long_R$rating == 999]
notSpecified_id <- goalRating_long_R$id[goalRating_long_R$rating == 99]
table(notSpecified_dimension)
table(notSpecified_id)
```

```{r}
# write the long format dataset
write.csv(goalRating_long_R, "./input/goalRating_long_R.csv", row.names = F)
```


```{r}
# generate goal list for other ratings
otherDf <- cleanedDf %>% dplyr::select(contains("goal_list"))
otherDF_long <- otherDf %>% gather(goal,content) %>% filter(content != "")
otherDF_long$goalID <- 1:nrow(otherDF_long)
write.csv(otherDF_long, "../raw_data/otherDf.csv", row.names = F)
```

